<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Restaurant</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const supabaseUrl = "https://pxdzdwljccgdruzaqhlt.supabase.co";
const supabaseKey = "sb_publishable_4_CsTkcZtuVeFxMSpjR8mQ_NpZaGkWX";
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

let restaurantId = null;
let menuItems = [];
let cart = [];
</script>

<style>
body{background:#0D0D0D;color:white;font-family:sans-serif}
</style>
</head>
<body>

<div class="max-w-xl mx-auto p-4">

<h1 id="restaurantName" class="text-2xl font-bold mb-4"></h1>

<div id="menu" class="space-y-4"></div>

<hr class="my-6 border-gray-700">

<h2 class="text-xl font-bold mb-3">Your Cart</h2>

<div id="cartItems" class="space-y-2 mb-4"></div>

<button onclick="checkout()" class="w-full bg-green-500 text-black font-bold py-3 rounded">
Place Order
</button>

</div>

<script>

// ðŸ”¥ LOAD RESTAURANT BY DOMAIN
async function loadRestaurant(){

const domain = window.location.hostname;

const { data, error } = await supabaseClient
.from("restaurants")
.select("*")
.eq("domain", domain)
.single();

if(error){
document.body.innerHTML = "<h1 style='padding:40px'>Restaurant Not Found</h1>";
return;
}

restaurantId = data.id;
document.getElementById("restaurantName").innerText = data.name;

loadMenu();
}

// ðŸ”¥ LOAD MENU
async function loadMenu(){

const { data, error } = await supabaseClient
.from("menu_items")
.select("*")
.eq("restaurant_id", restaurantId)
.eq("is_available", true);

if(error) return;

menuItems = data;
renderMenu();
}

// ðŸ”¥ RENDER MENU
function renderMenu(){

const menu = document.getElementById("menu");
menu.innerHTML = "";

menuItems.forEach(item=>{
menu.innerHTML += `
<div class="flex justify-between bg-[#1A1A1A] p-3 rounded">
<div>
<p class="font-bold">${item.name}</p>
<p>â‚¹${item.price}</p>
</div>
<button onclick="addToCart('${item.id}')"
class="bg-[#A8E63D] text-black px-3 py-1 rounded">
Add
</button>
</div>
`;
});
}

// ðŸ”¥ ADD TO CART
function addToCart(id){

const item = menuItems.find(m=>m.id==id);
const existing = cart.find(c=>c.id==id);

if(existing){
existing.qty++;
}else{
cart.push({id:item.id,name:item.name,price:item.price,qty:1});
}

renderCart();
}

// ðŸ”¥ RENDER CART
function renderCart(){

const container = document.getElementById("cartItems");
container.innerHTML="";

cart.forEach(item=>{
container.innerHTML += `
<div class="flex justify-between bg-[#1A1A1A] p-2 rounded">
<span>${item.qty}x ${item.name}</span>
<span>â‚¹${item.price * item.qty}</span>
</div>
`;
});
}

// ðŸ”¥ PLACE ORDER
async function checkout(){

if(cart.length===0){
alert("Cart empty");
return;
}

const total = cart.reduce((sum,i)=>sum+(i.price*i.qty),0);

try{

const { data:orderData, error:orderError } = await supabaseClient
.from("orders")
.insert([{
restaurant_id:restaurantId,
total_amount:total,
status:"pending"
}])
.select()
.single();

if(orderError) throw orderError;

const itemsToInsert = cart.map(item=>({
order_id:orderData.id,
item_name:item.name,
quantity:item.qty,
price:item.price
}));

await supabaseClient.from("order_items").insert(itemsToInsert);

alert("Order Placed Successfully");

cart=[];
renderCart();

}catch(err){
console.log(err);
alert("Order Failed");
}

}

loadRestaurant();

</script>

</body>
</html>