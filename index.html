<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zixy Bite - Digital Menu</title>
<script src="https://cdn.tailwindcss.com/3.4.17"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Inter:wght@400;500&display=swap" rel="stylesheet">

<style>
html, body { height: 100%; margin: 0; }
* { font-family: 'Inter', sans-serif; }
h1, h2 { font-family: 'Poppins', sans-serif; }

.category-pill { transition: all 0.3s ease; }
.category-pill.active {
  background: #A8E63D;
  color: #0D0D0D;
}

.menu-card { transition: all 0.3s ease; }
.menu-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 30px rgba(168, 230, 61, 0.15);
}
</style>
</head>

<body class="h-full bg-[#0D0D0D] text-white">

<div class="w-full min-h-full max-w-2xl mx-auto relative">

<header class="sticky top-0 z-50 bg-[#0D0D0D]/95 border-b border-[#2A2A2A] px-4 py-4">
  <h1 class="font-bold text-xl">Zixy Bite</h1>
  <p class="text-xs text-gray-400">Delicious Food, Delivered Hot</p>
</header>

<div class="sticky top-16 z-40 bg-[#0D0D0D]/95 px-4 py-3 border-b border-[#2A2A2A]">
  <input 
    type="text" 
    id="search-input"
    placeholder="Search dishes..."
    class="w-full px-4 py-2 rounded-lg bg-[#1A1A1A] border border-[#2A2A2A] text-white focus:outline-none focus:border-[#A8E63D]"
  >
</div>

<nav class="sticky top-28 z-40 bg-[#0D0D0D]/95 py-3 px-4 border-b border-[#2A2A2A]">
  <div id="category-pills" class="flex gap-2 overflow-x-auto"></div>
</nav>

<main id="menu-container" class="px-4 py-6 grid grid-cols-1 gap-6"></main>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const supabaseClient = supabase.createClient(
  "https://pxdzdwljccgdruzaqhlt.supabase.co",
  "sb_publishable_4_CsTkcZtuVeFxMSpjR8mQ_NpZaGkWX"
);

let allData = [];
let activeCategory = "All";
let searchQuery = "";
let cart = [];

// ðŸª‘ Detect Table Number
const params = new URLSearchParams(window.location.search);
const tableNumber = params.get("table") || "Unknown";

// ðŸ”¥ Load Menu
async function loadMenu() {
  const { data, error } = await supabaseClient
    .from("menu")
    .select("*");

  if (error) {
    console.error(error);
    return;
  }

  allData = data;
  renderCategories();
  renderMenu();
}

// ðŸ”¥ Render Categories
function renderCategories() {
  const container = document.getElementById("category-pills");

  const categories = [
    "All",
    ...new Set(allData.map(item => item.category))
  ];

  container.innerHTML = categories.map(cat => `
    <button 
      onclick="filterCategory('${cat}')"
      class="category-pill px-4 py-2 rounded-full text-sm whitespace-nowrap
      ${activeCategory === cat 
        ? 'active' 
        : 'bg-[#1A1A1A] border border-[#2A2A2A] text-white'}">
      ${cat}
    </button>
  `).join("");
}

function filterCategory(category) {
  activeCategory = category;
  renderCategories();
  renderMenu();
}

// ðŸ”¥ Render Menu
function renderMenu() {
  const container = document.getElementById("menu-container");

  let filtered = activeCategory === "All"
    ? allData
    : allData.filter(item => item.category === activeCategory);

  if (searchQuery) {
    filtered = filtered.filter(item =>
      item.name.toLowerCase().includes(searchQuery)
    );
  }

  container.innerHTML = filtered.map(item => `
    <div class="menu-card bg-[#1A1A1A] rounded-xl overflow-hidden">
      <img src="${item.image}" class="w-full h-52 object-cover">
      <div class="p-4">
        <h2 class="text-lg font-semibold">${item.name}</h2>
        <p class="text-[#A8E63D] font-bold text-lg">â‚¹${item.price}</p>
        <button 
          onclick="addToCart('${item.id}')"
          class="mt-3 w-full bg-[#A8E63D] text-black py-2 rounded-lg font-semibold">
          Add to Cart
        </button>
      </div>
    </div>
  `).join("");
}

// ðŸ”¥ Add To Cart
function addToCart(id) {
  const item = allData.find(i => i.id === id);

  const existing = cart.find(i => i.id === id);

  if (existing) {
    existing.qty += 1;
  } else {
    cart.push({
      id: item.id,
      name: item.name,
      price: item.price,
      qty: 1
    });
  }

  renderCart();
}

// ðŸ”¥ Render Cart
function renderCart() {
  const container = document.getElementById("cart-container");

  let total = 0;

  const itemsHtml = cart.map(item => {
    total += item.price * item.qty;
    return `
      <div class="flex justify-between text-sm mb-2">
        <span>${item.qty}x ${item.name}</span>
        <span>â‚¹${item.price * item.qty}</span>
      </div>
    `;
  }).join("");

  container.innerHTML = `
    ${itemsHtml}
    <hr class="my-2 border-[#2A2A2A]">
    <div class="flex justify-between font-bold text-lg">
      <span>Total</span>
      <span>â‚¹${total}</span>
    </div>
    <button 
      onclick="placeOrder(${total})"
      class="mt-4 w-full bg-[#A8E63D] text-black py-2 rounded-lg font-semibold">
      Place Order
    </button>
    <button 
      onclick="callWaiter()"
      class="mt-2 w-full bg-white text-black py-2 rounded-lg font-semibold">
      Call Waiter
    </button>
  `;
}

// ðŸ”¥ Place Order
async function placeOrder(total) {
  if (cart.length === 0) return alert("Cart is empty");

  const { data: order, error } = await supabaseClient
    .from("orders")
    .insert([
      {
        table_number: tableNumber,
        total_amount: total,
        status: "pending"
      }
    ])
    .select()
    .single();

  if (error) {
    console.error(error);
    return;
  }

  const orderItems = cart.map(item => ({
    order_id: order.id,
    item_name: item.name,
    quantity: item.qty,
    price: item.price
  }));

  await supabaseClient.from("order_items").insert(orderItems);

  alert("Order placed successfully!");

  cart = [];
  renderCart();
}

// ðŸ”” Call Waiter
async function callWaiter() {
  await supabaseClient.from("waiter_calls").insert([
    {
      table_number: tableNumber,
      status: "pending"
    }
  ]);

  alert("Waiter has been called!");
}

// ðŸ”Ž Search
document.getElementById("search-input")
  .addEventListener("input", (e) => {
    searchQuery = e.target.value.toLowerCase();
    renderMenu();
});

loadMenu();
</script>

</body>
</html>